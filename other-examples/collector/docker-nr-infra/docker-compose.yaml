services:
  # For more details, see: https://docs.newrelic.com/docs/infrastructure/infrastructure-agent/linux-installation/infra-agent-as-container/#basic-compose
  agent:
    container_name: newrelic-infra
    image: newrelic/infrastructure:latest
    cap_add:
      - SYS_PTRACE
    network_mode: host
    pid: host
    privileged: true
    volumes:
      # TODO (jack-berg): mounting the host root on mac never gets past "Synchronized File Shares" initialization
      # For some reason, this isn't the case when you run the equivalent docker command:
      # docker run --detach --name newrelic-infra --network=host --cap-add=SYS_PTRACE --privileged --pid=host --cgroupns=host --volume "/:/host:ro" --volume "/var/run/docker.sock:/var/run/docker.sock" --env NRIA_LICENSE_KEY=<NEW_RELIC_API_KEY> newrelic/infrastructure:latest
      #- "/:/host:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      # Enable container metrics collection from Docker API. For more details, see: https://docs.newrelic.com/docs/infrastructure/infrastructure-agent/linux-installation/instrument-container/#enable-container-metrics-collection-from-docker-api
      - "./docker-config.yml:/etc/newrelic-infra/integrations.d/docker-config.yml"
    environment:
      - NRIA_LICENSE_KEY=${NEW_RELIC_API_KEY}
      - USER_DOCKER_API=true
    restart: unless-stopped

  adservice:
    container_name: docker-nr-infra-adservice
    image: otel/demo:1.10.0-adservice
    ports:
      - "8080:8080"
    environment:
      - AD_SERVICE_PORT=8080
      - OTEL_SERVICE_NAME=adservice
      - OTEL_EXPORTER_OTLP_ENDPOINT=${NEW_RELIC_OTLP_ENDPOINT}
      - OTEL_EXPORTER_OTLP_HEADERS=api-key=${NEW_RELIC_API_KEY}
