# Telemetry Data Examples

This document shows concrete examples of the telemetry data generated by the error-generator and how it flows through the collector.

## ⚠️ Important: Transformation vs Filtering

**This example uses TRANSFORMATION, not filtering.**

- **All telemetry is sent to New Relic** - Nothing is dropped
- **Expected errors are transformed** - Their status/severity is changed so they don't inflate error rates
- **Visibility is maintained** - You can still query and see the transformed data

**What gets transformed:**
- Validation errors: Span status changed from `Error` to `Ok`, marked with `error.expected=true`
- Auth errors: Span status changed from `Error` to `Ok`, marked with `error.expected=true`
- WARN logs: Severity downgraded from `WARN` to `INFO`

**Result:** Error rates in New Relic reflect only unexpected/actionable errors, while you still have full visibility into expected errors for troubleshooting.

## Table of Contents
- [Trace/Span Examples](#tracespan-examples)
- [Log Examples](#log-examples)
- [Metric Examples](#metric-examples)
- [Transformation Examples](#transformation-examples)

---

## Trace/Span Examples

### Example 1: Successful Request Span

```json
{
  "resourceSpans": [{
    "resource": {
      "attributes": [
        {"key": "service.name", "value": {"stringValue": "error-generator"}},
        {"key": "service.version", "value": {"stringValue": "1.0.0"}},
        {"key": "host.name", "value": {"stringValue": "error-generator"}},
        {"key": "telemetry.sdk.language", "value": {"stringValue": "go"}}
      ]
    },
    "scopeSpans": [{
      "scope": {
        "name": "error-generator",
        "version": "1.0.0"
      },
      "spans": [{
        "traceId": "6aae93314fe034149cd85f07eac24bc5",
        "spanId": "f1be31bc6e4471d8",
        "name": "handle_request",
        "kind": "SPAN_KIND_INTERNAL",
        "startTimeUnixNano": "1704724800000000000",
        "endTimeUnixNano": "1704724800050000000",
        "attributes": [
          {"key": "request.number", "value": {"intValue": "42"}},
          {"key": "http.status_code", "value": {"intValue": "200"}},
          {"key": "error", "value": {"boolValue": false}}
        ],
        "status": {
          "code": "STATUS_CODE_OK",
          "message": "success"
        }
      }]
    }]
  }]
}
```

**What happens:** This span passes through all filters and is sent to New Relic.

---

### Example 2: Database Error Span

```json
{
  "resourceSpans": [{
    "resource": {
      "attributes": [
        {"key": "service.name", "value": {"stringValue": "error-generator"}},
        {"key": "service.version", "value": {"stringValue": "1.0.0"}}
      ]
    },
    "scopeSpans": [{
      "spans": [{
        "traceId": "8c3e5a2b9f1d4e7a6b2c8d9e0f1a2b3c",
        "spanId": "a1b2c3d4e5f67890",
        "name": "handle_request",
        "kind": "SPAN_KIND_INTERNAL",
        "startTimeUnixNano": "1704724801000000000",
        "endTimeUnixNano": "1704724801100000000",
        "attributes": [
          {"key": "request.number", "value": {"intValue": "43"}},
          {"key": "error.type", "value": {"stringValue": "database"}},
          {"key": "http.status_code", "value": {"intValue": "500"}},
          {"key": "error", "value": {"boolValue": true}},
          {"key": "telemetry.filtered", "value": {"boolValue": true}}  // Added by transform processor
        ],
        "status": {
          "code": "STATUS_CODE_ERROR",
          "message": "Database error: connection pool exhausted"
        }
      }]
    }]
  }]
}
```

**What happens:**
- Passes through `filter/traces` (database errors are NOT filtered by default)
- `transform/traces` adds `telemetry.filtered=true` attribute
- Sent to New Relic

---

### Example 3: Validation Error Span (Gets Filtered)

```json
{
  "resourceSpans": [{
    "resource": {
      "attributes": [
        {"key": "service.name", "value": {"stringValue": "error-generator"}}
      ]
    },
    "scopeSpans": [{
      "spans": [{
        "traceId": "1a2b3c4d5e6f7890abcdef1234567890",
        "spanId": "9876543210fedcba",
        "name": "handle_request",
        "kind": "SPAN_KIND_INTERNAL",
        "startTimeUnixNano": "1704724802000000000",
        "endTimeUnixNano": "1704724802025000000",
        "attributes": [
          {"key": "request.number", "value": {"intValue": "44"}},
          {"key": "error.type", "value": {"stringValue": "validation"}},
          {"key": "http.status_code", "value": {"intValue": "400"}},
          {"key": "error", "value": {"boolValue": true}}
        ],
        "status": {
          "code": "STATUS_CODE_ERROR",
          "message": "Validation error: invalid input parameters"
        }
      }]
    }]
  }]
}
```

**What happens:**
- Caught by `filter/traces` processor
- Filter condition: `attributes["error.type"] == "validation" and FILTER_VALIDATION_ERRORS=true`
- **DROPPED** - Not sent to New Relic

---

### Example 4: Auth Error Span with Sensitive Data

```json
{
  "resourceSpans": [{
    "scopeSpans": [{
      "spans": [{
        "traceId": "7f8e9d0c1b2a3e4f5a6b7c8d9e0f1a2b",
        "spanId": "fedcba9876543210",
        "name": "handle_request",
        "attributes": [
          {"key": "error.type", "value": {"stringValue": "auth"}},
          {"key": "http.status_code", "value": {"intValue": "401"}},
          {"key": "error", "value": {"boolValue": true}}
        ],
        "status": {
          "code": "STATUS_CODE_ERROR",
          "message": "Authentication error: invalid or expired token=abc123xyz"
        }
      }]
    }]
  }]
}
```

**After transform processor:**

```json
{
  "status": {
    "code": "STATUS_CODE_ERROR",
    "message": "Authentication error: invalid or expired token=REDACTED"
  },
  "attributes": [
    {"key": "telemetry.filtered", "value": {"boolValue": true}}
  ]
}
```

**What happens:**
- May be filtered by `filter/traces` if `FILTER_AUTH_ERRORS=true`
- If not filtered, `transform/traces` redacts `token=abc123xyz` → `token=REDACTED`
- Then sent to New Relic

---

## Log Examples

### Example 5: Successful Request Log

```json
{
  "resourceLogs": [{
    "resource": {
      "attributes": [
        {"key": "service.name", "value": {"stringValue": "error-generator"}}
      ]
    },
    "scopeLogs": [{
      "logRecords": [{
        "timeUnixNano": "1704724800050000000",
        "severityNumber": 9,
        "severityText": "INFO",
        "body": {
          "stringValue": "Request processed successfully"
        },
        "attributes": [
          {"key": "request.number", "value": {"intValue": "42"}},
          {"key": "http.status_code", "value": {"intValue": "200"}},
          {"key": "trace.id", "value": {"stringValue": "6aae93314fe034149cd85f07eac24bc5"}},
          {"key": "span.id", "value": {"stringValue": "f1be31bc6e4471d8"}}
        ],
        "traceId": "6aae93314fe034149cd85f07eac24bc5",
        "spanId": "f1be31bc6e4471d8"
      }]
    }]
  }]
}
```

**What happens:** Passes through (INFO level logs are not filtered) and sent to New Relic.

---

### Example 6: Database Error Log

```json
{
  "resourceLogs": [{
    "scopeLogs": [{
      "logRecords": [{
        "timeUnixNano": "1704724801100000000",
        "observedTimeUnixNano": "1704724801100500000",
        "severityNumber": 17,
        "severityText": "ERROR",
        "body": {
          "stringValue": "Database error: connection pool exhausted"
        },
        "attributes": [
          {"key": "error.type", "value": {"stringValue": "database"}},
          {"key": "http.status_code", "value": {"intValue": "500"}},
          {"key": "request.number", "value": {"intValue": "43"}},
          {"key": "trace.id", "value": {"stringValue": "8c3e5a2b9f1d4e7a6b2c8d9e0f1a2b3c"}},
          {"key": "span.id", "value": {"stringValue": "a1b2c3d4e5f67890"}},
          {"key": "telemetry.filtered", "value": {"boolValue": true}}  // Added by transform
        ],
        "traceId": "8c3e5a2b9f1d4e7a6b2c8d9e0f1a2b3c",
        "spanId": "a1b2c3d4e5f67890"
      }]
    }]
  }]
}
```

**What happens:**
- Passes through `filter/logs` (database ERROR logs are not filtered)
- `transform/logs` adds `telemetry.filtered=true` attribute
- Sent to New Relic with trace correlation (trace.id and span.id)

---

### Example 7: Validation Warning Log (Gets Filtered)

```json
{
  "resourceLogs": [{
    "scopeLogs": [{
      "logRecords": [{
        "timeUnixNano": "1704724802025000000",
        "severityNumber": 13,
        "severityText": "WARN",
        "body": {
          "stringValue": "Validation error: invalid input parameters"
        },
        "attributes": [
          {"key": "error.type", "value": {"stringValue": "validation"}},
          {"key": "http.status_code", "value": {"intValue": "400"}},
          {"key": "request.number", "value": {"intValue": "44"}},
          {"key": "trace.id", "value": {"stringValue": "1a2b3c4d5e6f7890abcdef1234567890"}},
          {"key": "span.id", "value": {"stringValue": "9876543210fedcba"}}
        ]
      }]
    }]
  }]
}
```

**What happens:**
- Caught by `filter/logs` processor (two reasons):
  1. `severity_text == "WARN" and FILTER_WARN_LOGS=true`
  2. `attributes["error.type"] == "validation" and FILTER_VALIDATION_ERRORS=true`
- **DROPPED** - Not sent to New Relic

---

### Example 8: Log with Sensitive Data

```json
{
  "resourceLogs": [{
    "scopeLogs": [{
      "logRecords": [{
        "severityText": "ERROR",
        "body": {
          "stringValue": "Auth failed for user email=user@example.com with token=secret123 and password=mypass123"
        },
        "attributes": [
          {"key": "error.type", "value": {"stringValue": "auth"}}
        ]
      }]
    }]
  }]
}
```

**After transform processor:**

```json
{
  "body": {
    "stringValue": "Auth failed for user email=REDACTED with token=REDACTED and password=REDACTED"
  },
  "attributes": [
    {"key": "error.type", "value": {"stringValue": "auth"}},
    {"key": "telemetry.filtered", "value": {"boolValue": true}}
  ]
}
```

**What happens:**
- `transform/logs` applies three redaction patterns:
  - `email=user@example.com` → `email=REDACTED`
  - `token=secret123` → `token=REDACTED`
  - `password=mypass123` → `password=REDACTED`
- Then sent to New Relic

---

## Metric Examples

### Example 9: Request Counter Metric

```json
{
  "resourceMetrics": [{
    "resource": {
      "attributes": [
        {"key": "service.name", "value": {"stringValue": "error-generator"}},
        {"key": "service.version", "value": {"stringValue": "1.0.0"}}
      ]
    },
    "scopeMetrics": [{
      "scope": {
        "name": "error-generator",
        "version": "1.0.0"
      },
      "metrics": [{
        "name": "requests.total",
        "description": "Total number of requests",
        "unit": "1",
        "sum": {
          "dataPoints": [{
            "startTimeUnixNano": "1704724800000000000",
            "timeUnixNano": "1704724810000000000",
            "asInt": "150",
            "attributes": []
          }],
          "aggregationTemporality": "AGGREGATION_TEMPORALITY_CUMULATIVE",
          "isMonotonic": true
        }
      }]
    }]
  }]
}
```

**What happens:** Not an error metric, passes through all filters and sent to New Relic.

---

### Example 10: Database Error Counter Metric

```json
{
  "resourceMetrics": [{
    "resource": {
      "attributes": [
        {"key": "service.name", "value": {"stringValue": "error-generator"}}
      ]
    },
    "scopeMetrics": [{
      "metrics": [{
        "name": "errors.total",
        "description": "Total number of errors by type",
        "unit": "1",
        "sum": {
          "dataPoints": [{
            "startTimeUnixNano": "1704724800000000000",
            "timeUnixNano": "1704724810000000000",
            "asInt": "45",
            "attributes": [
              {"key": "error.type", "value": {"stringValue": "database"}},
              {"key": "http.status_code", "value": {"intValue": "500"}},
              {"key": "telemetry.filtered", "value": {"boolValue": true}}  // Added by transform
            ]
          }],
          "aggregationTemporality": "AGGREGATION_TEMPORALITY_CUMULATIVE",
          "isMonotonic": true
        }
      }]
    }]
  }]
}
```

**What happens:**
- Passes through `filter/metrics` (database errors are not filtered)
- `transform/metrics` adds `telemetry.filtered=true` attribute
- Sent to New Relic

---

### Example 11: Validation Error Counter Metric (Gets Filtered)

```json
{
  "resourceMetrics": [{
    "scopeMetrics": [{
      "metrics": [{
        "name": "errors.total",
        "description": "Total number of errors by type",
        "sum": {
          "dataPoints": [{
            "timeUnixNano": "1704724810000000000",
            "asInt": "28",
            "attributes": [
              {"key": "error.type", "value": {"stringValue": "validation"}},
              {"key": "http.status_code", "value": {"intValue": "400"}}
            ]
          }]
        }
      }]
    }]
  }]
}
```

**What happens:**
- Caught by `filter/metrics` processor
- Filter condition: `name == "errors.total" and attributes["error.type"] == "validation" and FILTER_VALIDATION_ERRORS=true`
- **DROPPED** - Not sent to New Relic

---

### Example 12: Multiple Error Types in One Metric Export

```json
{
  "resourceMetrics": [{
    "scopeMetrics": [{
      "metrics": [{
        "name": "errors.total",
        "sum": {
          "dataPoints": [
            {
              "asInt": "45",
              "attributes": [
                {"key": "error.type", "value": {"stringValue": "database"}},
                {"key": "http.status_code", "value": {"intValue": "500"}}
              ]
            },
            {
              "asInt": "28",
              "attributes": [
                {"key": "error.type", "value": {"stringValue": "validation"}},
                {"key": "http.status_code", "value": {"intValue": "400"}}
              ]
            },
            {
              "asInt": "12",
              "attributes": [
                {"key": "error.type", "value": {"stringValue": "timeout"}},
                {"key": "http.status_code", "value": {"intValue": "504"}}
              ]
            },
            {
              "asInt": "8",
              "attributes": [
                {"key": "error.type", "value": {"stringValue": "auth"}},
                {"key": "http.status_code", "value": {"intValue": "401"}}
              ]
            }
          ]
        }
      }]
    }]
  }]
}
```

**After filtering (with FILTER_VALIDATION_ERRORS=true, FILTER_AUTH_ERRORS=true):**

```json
{
  "resourceMetrics": [{
    "scopeMetrics": [{
      "metrics": [{
        "name": "errors.total",
        "sum": {
          "dataPoints": [
            {
              "asInt": "45",
              "attributes": [
                {"key": "error.type", "value": {"stringValue": "database"}},
                {"key": "http.status_code", "value": {"intValue": "500"}},
                {"key": "telemetry.filtered", "value": {"boolValue": true}}
              ]
            },
            {
              "asInt": "12",
              "attributes": [
                {"key": "error.type", "value": {"stringValue": "timeout"}},
                {"key": "http.status_code", "value": {"intValue": "504"}},
                {"key": "telemetry.filtered", "value": {"boolValue": true}}
              ]
            }
          ]
        }
      }]
    }]
  }]
}
```

**What happens:**
- Validation error data point: **DROPPED**
- Auth error data point: **DROPPED**
- Database error data point: **KEPT** (with added attribute)
- Timeout error data point: **KEPT** (with added attribute)

---

## Filtering Examples

### Scenario: Filter Configuration Impact

Given this configuration in `.env`:
```bash
FILTER_VALIDATION_ERRORS=true
FILTER_AUTH_ERRORS=true
FILTER_WARN_LOGS=true
```

#### Over 1 minute with ERROR_RATE=0.3, REQUEST_INTERVAL_MS=2000

**Generated (30 requests, 9 errors):**
- 3 validation errors (400, WARN)
- 2 auth errors (401, WARN)
- 2 database errors (500, ERROR)
- 1 timeout error (504, ERROR)
- 1 network error (503, ERROR)

**Sent to New Relic:**

| Telemetry Type | Generated | Filtered | Sent | Filter Reason |
|----------------|-----------|----------|------|---------------|
| Validation error spans | 3 | 3 | 0 | error.type=validation |
| Auth error spans | 2 | 2 | 0 | error.type=auth |
| Database error spans | 2 | 0 | 2 | Not filtered |
| Timeout error spans | 1 | 0 | 1 | Not filtered |
| Network error spans | 1 | 0 | 1 | Not filtered |
| **Total spans** | **9** | **5** | **4** | **56% filtered** |
| | | | | |
| Validation WARN logs | 3 | 3 | 0 | severity=WARN + error.type |
| Auth WARN logs | 2 | 2 | 0 | severity=WARN + error.type |
| Database ERROR logs | 2 | 0 | 2 | Not filtered |
| Timeout ERROR logs | 1 | 0 | 1 | Not filtered |
| Network ERROR logs | 1 | 0 | 1 | Not filtered |
| Success INFO logs | 21 | 0 | 21 | Not filtered |
| **Total logs** | **30** | **5** | **25** | **17% filtered** |
| | | | | |
| Validation error metrics | 3 | 3 | 0 | error.type=validation |
| Auth error metrics | 2 | 2 | 0 | error.type=auth |
| Database error metrics | 2 | 0 | 2 | Not filtered |
| Timeout error metrics | 1 | 0 | 1 | Not filtered |
| Network error metrics | 1 | 0 | 1 | Not filtered |
| Request counter | 30 | 0 | 30 | Not an error metric |
| **Total metrics** | **39** | **5** | **34** | **13% filtered** |

**Summary:**
- **Traces:** 56% filtered (5 out of 9 error spans dropped)
- **Logs:** 17% filtered (5 out of 30 logs dropped)
- **Metrics:** 13% filtered (5 out of 39 metric data points dropped)

This filtering reduces noise from client errors (validation, auth) while keeping critical server errors (database, timeout, network).

---

## Viewing the Data in the Collector

To see this data in real-time, you can:

1. **Enable debug exporter** (already configured in `otel-config.yaml`):
```yaml
exporters:
  debug:
    verbosity: detailed  # Change from 'basic' to 'detailed'
```

2. **View collector logs**:
```bash
docker compose logs -f collector
```

3. **Check collector metrics** (shows filtering stats):
```bash
curl http://localhost:8888/metrics | grep processor
```

Look for metrics like:
- `otelcol_processor_filter_logs_filtered` - Number of logs filtered
- `otelcol_processor_filter_spans_filtered` - Number of spans filtered
- `otelcol_processor_filter_datapoints_filtered` - Number of metric data points filtered

---

## JSON Structure Reference

### Severity Number Mapping

| Severity Number | Severity Text | Description |
|----------------|---------------|-------------|
| 1-4 | TRACE | Trace-level logs |
| 5-8 | DEBUG | Debug-level logs |
| 9-12 | INFO | Informational messages |
| 13-16 | WARN | Warning messages |
| 17-20 | ERROR | Error messages |
| 21-24 | FATAL | Fatal errors |

### Span Status Codes

| Code | Name | Description |
|------|------|-------------|
| 0 | UNSET | Default status |
| 1 | OK | Operation completed successfully |
| 2 | ERROR | Operation failed |

### Aggregation Temporality

| Value | Description |
|-------|-------------|
| AGGREGATION_TEMPORALITY_CUMULATIVE | Cumulative (total since start) |
| AGGREGATION_TEMPORALITY_DELTA | Delta (change since last report) |